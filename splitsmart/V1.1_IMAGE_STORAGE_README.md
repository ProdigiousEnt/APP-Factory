# V1.1 Update: Local Image Storage

## Quick Reference

This directory contains code for the v1.1 update that adds local receipt image storage. **DO NOT implement until after v1.0 is approved.**

## Files Created

1. **`services/imageStorageService.ts.v1.1`**
   - Complete service for saving/loading images
   - Ready to rename to `.ts` when implementing

2. **`INTEGRATION_GUIDE_V1.1.ts`**
   - Step-by-step integration code
   - Shows exactly what to change in App.tsx

## Implementation Steps (v1.1)

### 1. Rename Service File
```bash
mv services/imageStorageService.ts.v1.1 services/imageStorageService.ts
```

### 2. Update Supabase Schema
```sql
ALTER TABLE receipts ADD COLUMN image_filename TEXT;
```

### 3. Update supabaseService.ts
Add `image_filename` parameter to `saveReceiptSession`:
```typescript
export const saveReceiptSession = async (
  userId: string | null,
  receiptData: ReceiptData,
  assignments: Assignment[],
  imageFilename?: string  // NEW
) => {
  const note = generateReceiptNote(receiptData, assignments);
  
  const { data, error } = await supabase
    .from('receipts')
    .insert({
      user_id: userId,
      app_id: APP_ID,
      total: receiptData.total,
      currency: receiptData.currency,
      items: receiptData.items,
      assignments: assignments,
      tax: receiptData.tax,
      tip: receiptData.tip,
      note: note,
      image_filename: imageFilename  // NEW
    })
    .select()
    .single();

  if (error) throw error;
  return data;
};
```

### 4. Apply Integration Code
Follow the code in `INTEGRATION_GUIDE_V1.1.ts` to update:
- Add state for `receiptImageData`
- Update `handleCapture` to store image
- Update `handleFileUpload` to store image
- Update `handleSaveReceipt` to save image locally
- Update `handleSelectHistory` to load images

### 5. Test Thoroughly
- [ ] Scan receipt → image saved locally
- [ ] View history → can see saved receipts
- [ ] App restart → images persist
- [ ] Delete receipt → image deleted
- [ ] Offline mode → can view saved receipts

## Benefits

✅ Zero cloud storage costs  
✅ Maximum privacy (images never leave device)  
✅ Fast (no upload/download)  
✅ Enables Annual Reports with actual receipt images  

## Storage Impact

- ~100 KB per receipt image (compressed JPEG)
- 50 receipts/year = 5 MB
- Negligible impact on device storage

## Future: Annual Report

Once images are stored, you can generate Annual Reports with:
- Summary statistics
- Charts and graphs
- List of receipts with thumbnails
- Full-size images in appendix

Use `react-pdf` or `pdfmake` to generate PDF reports on-device.

## Notes

- Images are stored in `Documents/receipts/`
- Filenames match receipt IDs from Supabase
- Cleanup function available to delete old images (2+ years)
- Storage usage can be displayed in Settings
